# Presence Server API Reference
- STOMP Client를 통해 접속
- STOMP 연결 예시는 `/src/main/resources/static/index.js` 참고
- 워크스페이스 입장 시점에 connect 함수 호출

## API List
| Protocol | Action/Method   | URL                      | description                              | DTO       | Return          | 호출 시점 |
|----------|-----------------|--------------------------|------------------------------------------|-----------|-----------------|-------|
| STOMP    | connect         | `/ws/presence`           | 소켓 연결 entry point                        | -         | -               | 연결 시  |
| STOMP    | publish         | `/app/update`            | 유저 상태 변화 메시지를 서버에 전송                     | UpdateDTO | UpdateDTO       | 서비스 중 |
| STOMP    | subscribe       | `/topic/workspace.{id}`  | `workspace.{id}`에 해당하는 exchange의 메시지를 구독 | -         | -               | 연결 시  |
| HTTP     | GET             | `/presence/{id}`         | `{id}`에 해당하는 워크스페이스의 멤버들의 상태 목록을 불러옴     | -         | List<UpdateDTO> | 서비스 중 |

- DTO의 모든 field는 String으로 입력
- UpdateDTO 예시
  ```
  {
    "workspaceId": "123",
    "userId": "456",
    "userStatus": "ONLINE"
  }
  ```
- `userStatus`는 `CONNECT` `ONLINE`, `ONLINE`, `ABSENT`, `BUSY`, `OFFLINE` 중에 설정
- `CONNECT` 상태 메시지는 소켓 연결 성공 즉시 단 한 번만 서버에 전송
- 로그아웃 혹은 비정상적 연결로 소켓 연결이 끊어진 멤버의 경우 서버에서 해당 멤버에 대해 `DISCONNECT` status 메시지를 publish (프론트엔드에서 `DISCONNECT`에 대한 처리 요망)
  - `DISCONNECT` 상태 메시지는 클라이언트가 전송하는 것이 아니고 서버에서 생성하여 전달함
  - `OFFLINE`은 자신을 오프라인 상태로 표시하고 싶은 멤버를 위한 선택지, `DISCONNECT`와 구분하여 사용할 것
- 위에 명시하지 않은 상태를 입력할 경우 `UNKNOWN` status로 저장 및 상태 변화를 전파하게 됨

## `userStatus` 명세
| 종류         | 메시지 생성 주체 | 전송 시점                  | 용도                                  | 비고                                                                                |
|------------|-----------|------------------------|-------------------------------------|-----------------------------------------------------------------------------------|
| CONNECT    | 클라이언트     | `Connect` 함수 호출 후      | 프리젠스 레코드 생성 혹은 세션 정보 추가             | `ONLINE`과 구분: DB에 사용자 상태는 `ONLINE`으로 저장되지만, 소켓 연결 이후 단 한 번만 `CONNECT` 타입으로 메시지 전송 |
| ONLINE     | 클라이언트     | 사용자가 상태를 변경할 때         | 사용자 상태 표시를 '온라인'으로 변경               |                                                                                   |
| ABSENT     | 클라이언트     | 사용자가 상태를 변경할 때         | 사용자 상태 표시를 '부재 중'으로 변경              |                                                                                   |
| BUSY       | 클라이언트     | 사용자가 상태를 변경할 때         | 사용자 상태 표시를 '다른 용무 중'으로 변경           |                                                                                   |
| OFFLINE    | 클라이언트     | 사용자가 상태를 변경할 때         | 사용자 상태 표시를 '오프라인'으로 변경              | `DISCONNECT`와 구분: 사용자 상태를 변경할 때 클라이언트가 보내 주는 상태 타입                                |
| DISCONNECT | 서버        | 해당 계정의 모든 세션이 로그아웃된 경우 | 클라이언트에 해당 사용자 상태를 '오프라인'으로 변경하도록 알림 | `OFFLINE`과 구분: 클라이언트가 생성해서 보내주는 메시지 타입이 아님                                        |


## API 사용 시나리오

### 소켓 연결
- 사용자가 워크스페이스 메인 페이지에 진입할 때 STOMP connect 함수를 통해 `/ws/presence` 엔드포인트에 소켓 연결 시도
  - 연결이 정상적으로 성립된 경우 다음 동작을 절차적으로 실행
  - STOMP subscribe 함수를 통해 `/topic/workspace.{id}`에 대해 구독
  - `GET /presence/{id}` 메소드를 요청하여 워크스페이스 멤버들 상태 목록을 DB에서 가져옴
  - STOMP publish 함수를 통해 `/app/update`에 현재 유저가 `CONNECT` 상태라는 정보 메시지를 보냄
    - 프론트엔드에서 다음 로직 처리 요망: `CONNECT` 메시지를 받았을 때 해당 유저가 목록에 없다면 `ONLINE`으로 추가, 있다면 해당 메시지 무시
- 프론트엔드는 소켓 정상 연결 후 받아온 멤버 상태 목록을 저장하고, 유저 상태 변화 메시지가 들어올 때마다 이 목록을 업데이트 해야 함

### 멤버 목록
- 프론트엔드는 멤버 상태 목록에 있는 유저는 해당 유저의 상태를 표시하고  목록에 없는 유저는 `OFFLINE` 상태로 표시
  - `userStatus`는 `CONNECT`, `ONLINE`, `ABSENT`, `BUSY`, `OFFLINE`, `DISCONNECTED` 중 하나이며, 유저 상태를 표시하기 위한 상태는 `CONNECT`, `DISCONNECT`를 제외한 나머지임
  - 상태 코드를 어떤 형태로 사용자에게 보여줄 지는 프론트엔드의 자율에 맡김 (e.g. '`ONLINE`: "온라인", `ABSENT`: 부재 중' 등)

### 상태 변화 업데이트
- STOMP publish 함수를 통해 `/app/update`에 현재 유저의 상태 변화를 알리는 메시지를 보냄
- UpdateDto에 허용되는 `userStatus`는 위에서 언급한 것과 동일

### 소켓 연결 해제
- 사용자가 로그아웃을 할 경우 STOMP disconnect 함수 호출
  - **주의: 클라이언트는 이 때 서버에 해당 사용자의 상태가 `DISCONNECT`로 바뀌었다는 메시지를 보내지 않음!**
- 다른 사용자가 로그아웃을 하거나 비정상적으로 연결이 종료된 경우, 프리젠스 서버는 소켓 연결이 끊김을 감지하고 해당 사용자가 연결 중이던 워크스페이스에 해당 유저의 상태가 `OFFLINE`으로 변했다는 메시지를 송신함

### 다중 접속 처리
- 프리젠스 서버는 하나의 사용자 계정으로 여러 세션에서 접속하는 경우를 처리하고 있음
- 프리젠스 DB의 레코드는 `(사용자 id, 워크스페이스 id)` 단위로 세션 목록을 관리
- 어떤 사용자가 하나의 계정으로 해당 워크스페이스에 처음 접속한 경우, 해당 유저의 프리젠스 정보 레코드를 DB에 입력하고 해당 사용자가 `ONLINE`이 되었다는 상태 메시지를 전달
- 사용자가 해당 계정을 통해 접속한 모든 세션에서 로그아웃할 때, DB에서 해당 사용자의 프리젠스 정보 레코드 삭제하고 해당 사용자가 `OFFLINE`이 되었다는 상태 메시지를 전달
- 사용자가 어떤 세션에서 어떤 계정으로 접속한 후 다른 세션에서 추가로 접속하는 경우, 레코드의 세션 목록에 세션 정보를 추가
  - 기존에 레코드가 존재하는 경우, 사용자 상태 정보를 업데이트하지 않고 세션 목록에만 세션 정보 추가 혹은 삭제
- 사용자가 기존에 접속한 세션에서 명시적으로 상태 변화 메시지를 송신하는 경우에만 상태 정보 업데이트
  - 사용자의 세션이 다시 연결되는 경우 상태 정보를 업데이트하지 않음
